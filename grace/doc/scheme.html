<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="content-type" content="text/html; charset=iso-8859-1"/>
<style type="text/css" media="all">
@import "grace.css";
</style>
<title>Grace with Real Time Scheduling and Scheme</title>
</head>

<body>
<div id="content">

<h1> Grace with Real Time Scheduling and Chicken Scheme</h1>

<ul>
  <li><a href="#introduction">Introduction</a></li>
  <li><a href="#scheduler">The Scheduler</a></li>
  <li><a href="#processes">Musical Processes</a></li>
  <li><a href="#ports">Ports</a></li>
  <li><a href="#toolbox">Composition Toolbox</a>
  <ul>
    <li><a href="#lists">Lists</a></li>
    <li><a href="#environment">Environment</a></li>
    <li><a href="#mapping">Mapping and Transformation</a></li>
    <li><a href="#randomness">Randomness</a></li>
    <li><a href="#midi-message">Midi Messages</a></li>
    </ul>
  <li><a href="#sal">SAL Syntax</a>
  </li>

  <li><a href="#examples">Examples</a></li>
<!--   <li><a href="#xml">XML Description</a></li> -->
</ul>

<h2 id="introduction">Introduction</h2>

<p>Grace can be built with either Common Lisp or <a
href="http://www.call-with-current-continuation.org">Chicken
Scheme</a> as its extension language for algorithmic composition.  The
CL binding supports file-based, non-real time work with software systems
like Common Music, CLM, Fomus etc. <!-- In the CL binding Grace
communicates with a (separate) Lisp process running SBCL or CLISP over
a network socket connection. --> The new Scheme binding is a
lightweight, minimalist interface designed for real time algorithmic
composition. </p>

<p>The distinguishing features of the Scheme binding compared to the
CL binding are:</p>

<ul>
  <li>Scheme is a part of the Grace executable and
  is always running</li>
  <li>Common Music is not involved.</li>
  <li>Scheduler is only real time and is always running</li>
  <li>Ports replace files </li>
  <li>XML replaces Lisp classes</li>
  <li>Future additions: SAL (very soon), XML point description for Plotter (soon), real time audio using JUCE Audio Plugin Framework (year)</li>
</ul>

<!-- blockquote>
<span style="font-size:small;">
* See <a href="#toolbox">Toolbox</a>. <br/>

</span>
</blockquote -->


<!-- p> The Common Lisp binding uses a network socket connection to send
data between Grace and a separate process running SBCL or CLISP with
Common Music loaded. It provides essentially non-realtime, file-based
algorithmic composition services.<p> </li -->

<!-- p>By default Grace builds with the Scheme back end and the Scheme
binding is the primary focus of Grace development in the future.  -->

<!-- p>To build Grace for use with Common Lisp specify 'scons CL=1'
on the command line. </p -->

<h2 id="scheduler">The Scheduler</h2>

<p>The scheduler is a JUCE thread that executes on a 1 millisecond
tick. There are just a few entry points:</p>

<dl id="sprout"><dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">sprout</span> (<var>process</var> [<var>ahead=0</var>] [<var>id=0</var>])<br/> &rarr; <var>void</var></code></dt>

<dd>Adds <a href="#processes"><var>process</var></a> to the scheduler
starting <var>ahead</var> time from now. If an optional integer
<var>id</var> is provided it tags the process in the scheduling queue;
tagged processes can then be selectively removed from the scheduler
using <a href="#stop"><code>stop</code></a>. The <var>process</var>
parameter can be a single process or list of processes. If it is a
list then <var>ahead</var> and <var>id</var> can also be lists and
their values are paired with each process in left-to-right order. See
<a href="#processes">Musical Processes</a> for more information.</dd>
</dl>

<dl id="stop"><dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">stop</span> ([<var>id</var>] <var>...</var>)<br/> &rarr; <var>void</var></code></dt>

<dd>Stops processes currently running in the scheduling queue. If no
ids are given all the processes are stopped, otherwise only processes
with the specified ids are removed. Multiple processes can share a
common id.</dd> </dl>

<dl id="hush"><dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">hush</span> ()<br/> &rarr; <var>void</var></code></dt>
<dd>Stops all processes currently running and flushes any pending events in the output queue.</dd>
</dl>

<dl id="pause"><dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">pause</span> ()<br/> &rarr; <var>void</var></code></dt>
<dd>Suspends the process scheduler.</dd>
</dl>

<dl id="cont"><dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">cont</span> ()<br/> &rarr; <var>void</var></code></dt>
<dd>Resumes (continues) the paused scheduler.</dd>
</dl>

<dl id="now"><dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">now ()</span><br/> &rarr; <var>float</var></code></dt>
<dd>Returns the current time of the scheduler. See also <a href="#elapsed"><code>elapsed</code></a><!-- and <a href="#time-format"><code>time-format</code -->.</dd>
</dl>

<!-- p>The <a href="#send"><code>send</code></a> function enqueues data
into the scheduler if the data's time stamp is in the future (greater
than 0).</p -->


<h2 id="processes">Musical Processes</h2>

<p>A musical process is a Scheme function of one argument that you <a
href="#sprout"><code>sprout</code></a> into the scheduler with an
(optional) delay time. At the appropriate (real) time the scheduler
calls the function and passes it the elapsed time since the process
was sprouted. The function executes and returns either (1) the amount
of time the scheduler should wait until it calls the function again or
(2) a negative number if the function should not be called
again. </p>

<h3 id="go">The <code>go</code> Macro</h3> <p>The <code>go</code>
macro is an easy way to create a process function, it has the same
syntax as Scheme's <a
href="http://www.schemers.org/Documents/Standards/R5RS/HTML/r5rs-Z-H-7.html#%_sec_4.2.4"><code>do</code></a>
but returns an iterative process instead of performing iteration
directly. It also wraps your code inside an error handler so Scheme
can't crash from errors under the callback:</p>

<dl><dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">go</span> ((<var>var</var> <var>init</var> [<var>step</var>]) <var>...</var>)
   (<var>stop?</var> <var>finally</var> <var>...</var>)
  <var>body</var> <var>...</var></code></dt>
<dd>

After the name of the macro comes its <var>binding list</var>, each
binding is a list containing the name of a local variable
<var>var</var> followed by its initial value <var>init</var> and an
(optional) stepping expression <var>step</var>. After the binding list
comes the termination clause that is evaluated each time through the
loop; if the <var>stop?</var> expression is true then any
<var>finally</var> expressions are evaluated and the process stops
running.  If the <var>stop?</var> expression evaluates to false then
each <var>body</var> form is evaluated in sequential order.  These
forms have access to two local functions that are only defined within
the lexical body of <code>go</code>:</dd> </dl>

<dl id="wait"><dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">wait</span> (<var>ahead</var>)<br/>&rarr; <var>float</var></code></dt>

<dd><p>A local function only defined within the body of <a
href="#go"><code>go</code></a> that sets the time delta for the next
runtime of the process.</p></dd>

</dl>

<dl id="elapsed"><dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">elapsed</span> ()<br/>&rarr; <var>float</var></code></dt>

<dd><p>A local function only defined within the body of <a
href="#go"><code>go</code></a> that returns the elapsed time since the
process was first sprouted.</p></dd>

</dl>
  
<h4>Example</h4>

<blockquote>
<pre>(<span class="special">define</span> (<span class="defined">simp</span> n)
  (<span class="special">go</span> ((i 0 (+ i 1))
       (k 60 (ran 30 70)))
      ((= i n)  )
    (send <span class="string">"mp:note"</span> <span class="keyword">#:key</span> k)
    (wait .1)))

(sprout (simp 20))</pre>  
</blockquote>

<h2 id="ports">Ports</h2>

<p> Ports are JUCE singletons that route data from/to 
devices, displays, files, etc. The set of available ports is determined
at compile time. <!-- For example, if Grace is compiled with OSC
support then the application will have an Osc port, otherwise it will
not.  Grace opens all its ports automatically when it starts
up. --> Port configurations can be customized using the Ports menu in the Console window. The current state of each port is saved in the Grace.pref file.</p>

<p>The following ports are always defined in Grace. The name in
parenthesis is the port's <var>prefix</var> that can appear in <a
href="#send"><code>send</code></a> statements to route data to the
port.</p>

<ul>
<li> Midi Port (<code>mp</code>) connects to an external Midi device or application.</li>
<li> Csound Port (<code>sc</code>) connects to CSound5 library for realtime audio.</li>
<li> Plotter Port (<code>pp</code>) connects to the top-most plotter display window. (not yet implemented)</li>

</ul>

<p>Other ports will be provided, possibly:</p>

<ul>

<li> OSC Port using <a href="http://www.audiomulch.com/~rossb/code/oscpack/">oscpack</a> </li>
<li> Fomus using the (upcoming) C++ version of Fomus (libfomus) </li>
<li> Supercollider using synthpatch templates in XML? </li>
<li> Audio Plugin Port using new JUCE audio plugin framework </li>
<li> OpenGL Port using JUCE OpenGL binding</li>
</ul>

<h3 id="send">Sending Data To Ports</h3>

<p>Every port implements a set of <var>methods</var> that you can send
data to. The <a href="#send"><code>send</code></a> macro routes data to a specific method
on a port:</p>

<dl>
  <dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">send</span> <var>message data...</var><br/>&rarr; <var>void</var></code></dt>
<dd>

<p>

The first argument to <code>send</code> is its <var>message</var>, a
literal string or symbol in the format <var>port</var><span
style="font-weight: bold;">:</span><var>method</var> that identifies a
specific port and method to receive the <var>data</var> specified as
positional and/or keyword arguments to the macro. Parameters that do
not appear receive their default values (if any). Its an error to
specify positional values once keyword arguments have been introduced
or for a keyword name to appear more than once in the data list.  </p>
</dd> </dl>

<h4>Example</h4>

<blockquote>
<pre>
(send <span class="string">"mp:note"</span> <span class="keyword">#:key</span> 70)
(send <span class="string">"mp:note"</span> 0 1 60 .1 0)
(send <span class="string">"mp:note"</span> 0 1 <span class="keyword">#:key</span> 60 <span class="keyword">#:chan</span> 10)
(send <span class="string">"mp:note"</span> <span class="keyword">#:chan</span> 10 <span class="keyword">#:time</span> 2 <span class="keyword">#:key</span> 60)
</pre>
</blockquote>

<!-- 
<h3 id="nrt">Sending Data in Non-Real Time</h3>

<p> Some ports, like the Plotter Port or Midi Seq, are non-real time
in the sense that data can be incrementally inserted into the port's
buffer any point. Events in the buffer share a single (zero-based)
time line. When you send data it should contain a zero based time
stamp.  <!-- Data sent without a time stamp will be added at time zero
in the buffer otherwise it will be inserted at its proper temporal
position in the buffer: --></p>

<blockquote>
<pre>(<span class="special">do</span> ((i 0 (+ i 1)))
    ((= i 100) <span class="keyword">#f</span>)
  (send <span class="string">"pp:note"</span> <span class="keyword">#:time</span> (ran 20.0) <span class="keyword">#:key</span> (ran 60 80)))
</pre>
</blockquote>

<p>To add data from a real time process you can use <a
href="#elapsed"><code>elapsed</code></a> values as the (zero-based)
time stamp for the data that is sent to a non-real time port:</p>

<blockquote>
<pre>(<span class="special">go</span> ((i 0 (+ i 1))
     (k 60 (ran 40 70)))
    ((= i 100) <span class="keyword">#f</span>)
  (send <span class="string">"mp:note"</span> <span class="keyword">#:key</span> k)
  (send <span class="string">"pp:note"</span> <span class="keyword">#:time</span> (elapsed) <span class="keyword">#:key</span> k)
  (wait (ran .1 .4)))
</pre>  
</blockquote>

-->

<h3>Midi Port Methods</h3>

<p>Before sending anything to the Midi Port first make sure you have
an output connection established with the <span
class="menuitem">Ports&gt;Midi Out&gt;</span> Menu in the Console
window. You can test that the connection actually works by using the
<span class="menuitem">Ports&gt;Midi Out&gt;Test</span> to send a
random burst of messages to the output device.</p>

<dl>
  <dt id="mp:note" style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">send</span> <span class="string">"mp:note"</span> <var>time=0</var> <var>dur=.5</var> <var>key=60</var> <var>amp=.5</var> <var>chan=0</var></code></dt>
  <dd><p>Sends note data to midi port.</p></dd>

  <dt id="mp:on" style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">send</span> <span class="string">"mp:on"</span> <var>time=0</var> <var>key=60</var> <var>vel=64</var> <var>chan=0</var></code></dt>
  <dd><p>Sends note on data to midi port. </p></dd>

  <dt id="mp:off" style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">send</span> <span class="string">"mp:off"</span> <var>time=0</var> <var>key=60</var> <var>vel=127</var> <var>chan=0</var></code></dt>
  <dd><p>Sends note off data to midi port.</p></dd>

  <dt id="mp:prog" style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">send</span> <span class="string">"mp:prog"</span> <var>time=0</var> <var>val=0</var> <var>chan=0</var></code></dt>
  <dd><p>Sends program change value to midi port. </p></dd>

  <dt id="mp:ctrl" style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">send</span> <span class="string">"mp:ctrl"</span> <var>time=0</var> <var>num=0</var> <var>val=0</var> <var>chan=0</var></code></dt>
  <dd><p>Sends control change data to midi port.</p></dd>

  <dt id="mp:touch" style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">send</span> <span class="string">"mp:touch"</span> <var>time=0</var> <var>val=0</var> <var>chan=0</var></code></dt>
  <dd>
    <p>Sends after touch value to midi port.</p>
  </dd>

  <dt id="mp:press" style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">send</span> <span class="string">"mp:press"</span> <var>time=0</var> <var>val=0</var> <var>chan=0</var></code></dt>
  <dd>
    <p>Sends channel pressure value to midi port.</p>
  </dd>

  <dt id="mp:bend" style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">send</span> <span class="string">"mp:bend"</span> <var>time=0</var> <var>val=8192</var> <var>chan=0</var></code></dt>
  <dd>
    <p>Sends pitch bend value 0-16383 to midi port.</p>
  </dd>

  <dt id="mp:mm" style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">send</span> <span class="string">"mp:mm"</span> <var>message</var></code></dt>
  <dd>
    <p>Sends a low-level <a href="#midimessage">MIDI message</a> to the midi port.
  </dd>

  <dt id="mp:inhook" style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">send</span> <span class="string">"mp:inhook"</span> <var>function</var></code></dt>
  <dd><p>Sets <var>function</var> to receive Midi Messages that arrive at the Midi In port. The function is passed a single argument, the Midi Message receieved. See <a href="midimessage">Midi Messages</a> for more information. The hook should call <a href="#mm:free"><code>mm:free</code></a> on any message that it does not send to the output port.</p></dd>

</dl>

<h3 id="csound">Csound Port Methods</h3>

<p>For realtime audio with Csound use the <span class="menuitem">Ports&gt;Csound&gt;Configure...</span> dialog to configure the Csound port with your audio settings and CSD file and then select <span class="menuitem">Ports&gt;Csound&gt;Open</span> to open the port. Once the port is open you can send data to Csound in real time using the <a href="#send"><code>send</code></a> methods documented below. Use <span class="menuitem">Ports&gt;Csound&gt;Clos</span> to close the port when you are done. Note that you can open and close the Csound port multiple times in the same session, optionally reconfiguring it with different settings and CSD files each time you open it. Your Csound configuraion is saved in the Grace preferences file so that when you restart Grace the port will contain your last settings.</p>

<dl>
<dt id="sc:i" style="background-color:#e6e6ff;">
  <code><span style="font-weight:bold;">send</span> <span class="string">"sc:i"</span> <var>ins start duration ...</var></code>
  <br/>
<code><span style="font-weight:bold;">send</span> <span class="string">"sc:i"</span> <var>list</var></code></dt>

  <dd>

   <p>Sends instrument data to the open Csound port.  The first value
    should be the instrument's number followed by the rest of its
    pfield values. For realtime audio the <var>start</var> value
    (pfield 2) should be 0. The <span class="string">"cs:i"</span>
    message also accepts a single <var>list</var> of values to be
    specified, in which case the <var>list</var> should contain the
    pfield data to send to Csound. The <span
    class="string">"cs:i"</span> message is also implemented as a
    Scheme function of the same name that can be called directly. For
    example, the following Scheme expressions are equivalent: </p>
    
<pre class="code">
(send <span class="string">"cs:i"</span> 1 0 1 60 1000)
(cs:i 1 0 1 60 1000)

(<span class="special">define</span> <span class="defined">mypars</span> '(1 0 1 60 1000))

(send <span class="string">"cs:i"</span> mypars)
(cs:i mypars)
</pre>
<p>  </p>
</dd>

<dt id="sc:f" style="background-color:#e6e6ff;">
  <code><span style="font-weight:bold;">send</span> <span class="string">"sc:f"</span> <var>num ...</var></code>
  <br/>
<code><span style="font-weight:bold;">send</span> <span class="string">"sc:f"</span> <var>list</var></code></dt>
<dd><p>Sends function table data to Csound. Similar to <span class="string">"sc:i"</span> in all other respects.
  </dd>
  </dl>

<p>See <a href="#example5">Example 5</a> for an example of sending data to the Csound port.</p>
  
<!--

<h3>Midi Seq Methods</h3>
<p>Supports reading and writing data from/to a Midi Sequence. (Not yet implemented.)</p>
<dl>
  <dt><code>send <span class="string">"ms:note"</span> <var>time</var> <var>dur</var> <var>key</var> <var>amp</var> <var>chan</var></code></dt>
  <dd>Sends note data to midi sequence port</dd >
  <dt><code>(send <span class="string">"ms:prog"</span> <var>time prog chan</var></code></dt>
  <dd>Sends Program Change data to midi sequence port</dd >
  <dt><code>send <span class="string">"ms:ctrl"</span> <var>time ctrl val chan</var></code></dt>
  <dd>Sends Control Change data to midi sequence port.</dd >
  <dt><code>send <span class="string">"ms:play"</span>)</dt>
  <dd>Plays current midi sequence.</dd >
  <dt><code>send( <span class="string">"ms:stop"</span>)</dt>
  <dd>Stops playing current midi sequence and rewinds to start to of sequence.</dt>
  <dt><code>send<span class="string">"ms:pause"</span>)</dd >
  <dd>Stops playing current midi sequence.</dt>
  <dt><code>send<span class="string">"ms:new"</span>)</dt>
  <dd>Creates new sequence, pushing old one onto sequence stack.</dd >
  <dt><code>send<span class="string">"ms:clear"</span>)</dt>
  <dd>Clears sequence of any data. </dd >
  <dt><code>send<span class="string">"ms:save"</span>)</dt>
  <dd>Saves sequence data to disk as midi file. </dd >
  <dt><code>send<span class="string">"ms:saveall"</span>)</dt>
  <dd>Saves all sequences to disk as level 1 midi file. </dd >
  <dt><code>send<span class="string">"ms:saveas"</span> <var>file</var></dt>
  <dd>Saves current sequence to specified file. Use .xml extension to save data as formatted XML text. </dd >
  <dt><code>send<span class="string">"mf:mapnotes"</span>  <var>function</var> </span>)</dt>
  <dd>Maps <var>function</var> over note data in sequence. Function args must be arity 5:  (time dur key amp chan).</dd >
  <dt><code>send<span class="string">"mf:load"</span> <var>file</var> </span>)</dt>
  <dd>Load .mid or .xml file into sequence.</dd >
  <dt><code>send<span class="string">"mf:plot"</span> <var>file</var> </span>)</dt>
  <dd>Send midi sequence to a Plotter window.</dd >
</dl>


<h3>Plotter Port Methods</h3>
<p>Routes data to the focus layer of the current plotter window. (Not yet implemented.)</p>

-->

<h2 id="toolbox">Composition Toolbox</h2>

<p>The following functions have been added to Chicken Scheme to facilite algorithmic music compostion. Over time
most of CM's toolbox will become available as optional modules, e.g.
<code> (use patterns)</code>, <code> (use tuning)</code>,  etc.</p>

<h3 id="lists">Lists</h3>

<dl id="list*">
  <dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">list*</span> (<var>...</var> <var>list</var>)<br/>&rarr; <var>list</var></code></dt>
<dd>Adds the elements in <var>...</var> onto the front of <var>list</var></dd>
</dl>

<dl id="first">
<dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">first</span> (<var>list</var>) <!-- br/> <var>...</var --> <br/> ... <span style="font-weight:bold;">tenth</span> (<var>list</var>)<br/>&rarr; <var>object</var></code></dt>
<dd>Accessors returning the first, second, third, fourth, fifth, sixth, seventh, eighth, ninth and tenth element of a <var>list</var>.  </dd>
</dl>

<dl id="rest">
<dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">rest</span> (<var>list</var>)<br/>&rarr; <var>list</var></code></dt>
<dd>Returns a list of all but the first element in <var>list</var>. </dd>
</dl>

<dl id="last">
<dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">last</span> (<var>list</var>)<br/>&rarr; <var>list</var></code></dt>
<dd>Returns the last (tail) list in <var>list</var>. </dd>
</dl>


<dl id="butlast">
<dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">butlast</span> (<var>list</var>)<br/>&rarr; <var>list</var></code></dt>
<dd>Returns all but the last (tail) list in <var>list</var>. </dd>
</dl>

<h3 id="environment">Environment</h3>

<dl id="current-directory">
<dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">current-directory</span> ()<br/>&rarr; <var>list</var></code></dt>
<dd>Returns the full pathname string to the current working directory. </dd>
</dl>

<dl id="change-directory">
<dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">change-directory</span> (<var>pathname</var>)<br/>&rarr; <var>void</var></code></dt>
<dd>Changes the current working directory to the <var>pathname</var> string. </dd>
</dl>

<h3 id="mapping">Mapping and Transformation</h3>

<dl id="rescale">
<dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">rescale</span> (<var>x</var> <var>x1</var> <var>x2</var> <var>y1</var> <var>y2</var> [<var>base=1</var>]) <br/>&rarr; <var>float</var></code></dt>
<dd>Returns a floating point value between <var>y1</var> and <var>y2</var> that is proportional to <var>x</var> between <var>x1</var> and <var>x2</var>. If <var>base</var> is 1 the rescaling is linear otherwise its exponential where <var>base</var> &gt; 1 produce increasing spread as <var>x</var> approaches <var>x2</var> and values  &lt; 1 produce decreasing spread.</dd></dl>
  
<dl id="discrete">
<dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">discrete</span> (<var>x</var> <var>x1</var> <var>x2</var> <var>d1</var> [<var>d2</var>] [<var>base=1</var>])<br/>&rarr; <var>sexpr</var></code></dt>
<dd>Similar to <code>rescale</code> except floating point <var>x</var> is mapped onto discrete values. If <var>d1</var> and <var>d2</var> are integers then <var>x</var> is mapped onto the range of integers  <var>d1</var> to <var>d2</var>. Otherwise, <var>d1</var> should be a list of values and <var>x</var> is mapped onto the elements of <var>d1</var> with <var>d2</var> an optional length that defaults to the length of <var>d1</var>. </dd></dl>

<dl id="interpl">
<dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">interpl</span> (<var>x</var> <var>list</var> [<var>base=1</var>])<br/>&rarr; <var>float</var></code></dt>
<dd>Same as CM.</dd></dl>

<dl id="interp">
<dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">interp</span> (<var>x</var> <var>x1 y1</var> <var>...</var>)<br/>&rarr; <var>float</var></code></dt>
<dd>Same as CM.</dd></dl>

<dl id="steps">
<dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">steps</span> (<var>len</var> <var>from</var> <var>step</var> <var>...</var>)<br/>&rarr; <var>list</var></code></dt>
<dd>Returns a list of <var>len</var> values starting on <var>from</var> and incremented by each <var>step</var> (positive or negative) read mod the number of steps. For example, <code>(steps 24 60 2 1 )</code>  would return a 3 octave ascending octatonic scale starting on key number 60.</dd></dl>


<dl id="rhythm-seconds">
<dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">rhythm-&gt;seconds</span> (<var>fraction</var> [<var>tempo</var>=60] [<var>beat</var>=1])<br/>&rarr; <var>float</var></code></dt>
<dd>Returns the time in seconds of <var>fraction</var> of <var>beat</var> in <var>tempo</var>.</dd></dl>

<dl id="cents-scaler">
<dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">cents-&gt;scaler</span> (<var>cents</var>)<br/>&rarr; <var>float</var></code></dt>
<dd>Same as CM.</dd></dl>

<dl id="scaler-cents">
<dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">scaler-&gt;cents</span> (<var>scaler</var>)<br/>&rarr; <var>int</var></code></dt>
<dd>Same as CM.</dd></dl>

<dl id="hertz-keynum">
<dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">hertz-&gt;keynum</span> (<var>hertz</var>)<br/>&rarr; <var>float</var></code></dt>
<dd>Returns floating point key number of <var>hertz</var>.</dd></dl>

<dl id="keynum-hertz">
<dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">keynum-&gt;hertz</span> (<var>knum</var>)<br/>&rarr; <var>float</var></code></dt>
<dd>Returns hertz value of key number.</dd></dl>

<dl id="keynum-pc">
<dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">keynum-&gt;pc</span> (<var>knum</var>)<br/>&rarr; <var>int</var></code></dt>
<dd>Returns integer pitch class of key number.</dd></dl>

<dl id="int">
<dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">int</span> (<var>x</var>)<br/>&rarr; <var>int</var></code></dt>
<dd>Rounds a floating point <var>x</var> to the nearest fixnum integer.</dd></dl>

<dl id="quantize">
<dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">quantize</span> (<var>x</var> <var>step</var>)<br/>&rarr; <var>float</var></code></dt>
<dd>Same as CM. <!-- Rounds a floating point <var>x</var> to the nearest multiple of <var>step</var> --></dd></dl>


<!-- dl id="decimals">
<dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">decimals</span> (<var>x</var> [<var>precision</var>=3])<br/>&rarr; <var>float</var></code></dt>
<dd>Same as CM. </dd></dl -->

<h3 id="randomness">Randomness</h3>

<p>All the functions that perform random selection are based on a common C++ random
state object that can be seeded using <a href="#ran-set!"><code>ran-set!</code></a>.</p>

<h4>Uniform Distribution</h4>

<dl id="ran">

<dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">ran</span> ([<var>n</var>=1.0] [<var>n2</var>])<br/>&rarr; <var>int</var> | <var>float</var></code></dt>

<dd>If called without arguments returns a random floating point number between 0
and 1 (exclusive). Otherwise <var>n</var> should be a positive or
negative number and a random number 0 to <var>n</var> (exclusive) and
of the same type as <var>n</var> (int or float) is returned. If
<var>n2</var> is provided then a random number between <var>n</var>
and <var>n2</var> (exclusive) is returned where <var>n2</var> can be
greater or less than <var>n</var>.</dd>

</dl>

<dl><dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">odds</span> (<var>n</var> [<var>true</var>=#t] [<var>false</var>=#f])<br/>&rarr; <var>sexpr</var></code></dt>
<dd>Same as CM.</dd></dl>

<dl id="pickl"><dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">pickl</span> (<var>list</var>)<br/>&rarr; <var>sexpr</var></code></dt>
<dd>Same as CM.</dd></dl>

<dl id="pick"><dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">pick</span> (<var>arg</var> <var>...</var>)<br/>&rarr; <var>sexpr</var></code></dt>
<dd>Same as CM.</dd></dl>

<dl id="between"><dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">between</span> (<var>low</var> <var>high</var>)<br/>&rarr; <var>number</var></code></dt>
<dd>Same as CM.</dd></dl>





<h4>Nonuniform Distributions</h4>

<dl id="ranpink"><dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">ranpink</span> ()<br/>&rarr; <var>float</var></code></dt>
<dd>Returns a pinkish  (1/f)  value between -1 and 1.</dd></dl>

<dl id="ranbrown"><dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">ranbrown</span> ()<br/>&rarr; <var>float</var></code></dt>
<dd>Returns a brownish  (1/f<sup>2</sup>) value between -1 and 1.</dd></dl>

<dl id="ranlow"><dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">ranlow</span> ()<br/>&rarr; <var>float</var></code></dt>
<dd>Returns a value between 0 and 1 with lower values more likely.</dd></dl>

<dl id="ranhigh"><dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">ranhigh</span> ()<br/>&rarr; <var>float</var></code></dt>
<dd>Returns a value between 0 and 1 with higher values more likely.</dd></dl>

<dl id="ranmid"><dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">ranmiddle</span> ()<br/>&rarr; <var>float</var></code></dt>
<dd>Returns a value between 0 and 1 with middle values more likely.</dd></dl>

<dl id="rangauss"><dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">rangauss</span> ([<var>lambda=1</var>] [<var>mu</var>=0])<br/>&rarr; <var>float</var></code></dt>
<dd>Returns unbounded value from the  <a href="http://en.wikipedia.org/wiki/Normal_distribution">normal distribution</a> with standard deviation <var>lambda</var> and mean <var>mu</var>.</dd></dl>

<dl id="ranexp"><dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">ranexp</span> ([<var>lambda=1</var>])<br/>&rarr; <var>float</var></code></dt>
<dd>Returns a value greater than 0 from the  <a href="">exponential distribution</a> with stretching factor <var>lambda</var>.</dd></dl>

<dl id="ranbeta"><dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">ranbeta</span> ([<var>a</var>=.5] [<var>b</var>=<var>a</var>])<br/>&rarr; <var>float</var></code></dt>
<dd>Returns value between 0 and 1 from the  <a href="http://en.wikipedia.org/wiki/Beta_distribution">beta distribution</a>.</dd></dl>

<dl id="rangamma"><dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">rangamma</span> ([<var>k</var>=1])<br/>&rarr; <var>float</var></code></dt>
<dd>Returns value greater than 0 from the  <a href="http://en.wikipedia.org/wiki/Gamma_distribution">gamma distribution</a>.</dd></dl>


<dl id="rancauchy"><dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">rancauchy</span> ()<br/>&rarr; <var>float</var></code></dt>
<dd>Returns an unbounded value from the <a href="http://en.wikipedia.org/wiki/Cauchy_distribution">Cauchy distribution</a>.</dd></dl>


<dl id="ranpoisson"><dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">ranpoisson</span> ([<var>lambda=1</var>])<br/>&rarr; <var>float</var></code></dt>
<dd>Returns an unbounded integer value from the <a href="http://en.wikipedia.org/wiki/Poisson_distribution">Poisson distribution</a> with shape factor <var>lambda</var>.</dd></dl>

<h4>Seeding</h4>

<dl id="ran-set"><dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">ran-set!</span> (<var>uint</var>)<br/>&rarr; <var>void</var></code></dt><dd>Initialize the random state generator with the unsigned integer value <var>uint</var>.</dd></dl>

<h3 id="midi-message">Low Level Midi Messages</h3>

<p> MIDI input data comes directly from the open MIDI input device
packaged as (C++) MidiMessage object. The following scheme functions
provided an API for manipulating these low-level structures.</p>

<dl id="mm:make"><dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">mm:make</span> (<var>type args...</var>)<br/>&rarr; <var>message</var></code></dt>
<dd>

<p>
Allocates a new a low-level JUCE MidiMessage according to a specified channel message <var>type</var> followed by zero or more keyword arguments as approprate to <var>type</var>.
</p>

<p>
The following message type constants are defined:
</p>
  
<blockquote>
<code class="entry">mm:off mm:on mm:touch mm:ctrl mm:prog mm:press mm:bend</code>
</blockquote>
<p>
Keyword arguments applicable to all types of messages:
</p>

<dl>
<dt><code class="keyword">#:time</code> <var>float</var></dt>
<dd>The time (in seconds) to wait before the event will sound. Defaults to 0.0</dd>

<dt><code class="keyword">#:chan</code> <var>integer</var></dt>
<dd>The channel number of the event. Defaults to 0.</dd>

</dl>

<p>
Keyword arguments applicable to <code class="entry">mm:off</code> messages:
</p>
<dl>
<dt><code class="keyword">#:key</code> <em>integer</em></dt>
<dd>An integer key number value 0-127. Defaults to 60.</dd>
</dl>

<p>
Keyword arguments applicable to <code class="entry">mm:on</code> messages:
</p>
<dl>
<dt><code class="keyword">#:key</code> <em>integer</em></dt>
<dd>An integer key number value 0-127. Defaults to 60.</dd>
<dt><code class="keyword">#:vel</code> <em>integer</em></dt>
<dd>An integer velocity value 0-127. Defaults to 64.</dd>
</dl>

<p>
Keyword arguments applicable to <code class="entry">mm:touch</code> messages:
</p>
<dl>
<dt><code class="keyword">#:val</code> <em>integer</em></dt>
<dd>An integer aftertouch value 0-127. Defaults to 0.</dd>
</dl>

<p>
Keyword arguments applicable to <code class="entry">mm:ctrl</code> messages:
</p>
<dl>
<dt><code class="keyword">#:num</code> <em>integer</em></dt>
<dd>A integer controller number 0-127. Defaults to 0.</dd>
<dt><code class="keyword">#:val</code> <em>integer</em></dt>
<dd>An integer control change value 0-127. Defaults to 0.</dd>
</dl>

<p>
Keyword arguments applicable to <code class="entry">mm:prog</code> messages:
</p>
<dl>
<dt><code class="keyword">#:val</code> <em>integer</em></dt>
<dd>An integer program change value 0-127. Defaults to 0.</dd>
</dl>

<p>
Keyword arguments applicable to <code class="entry">mm:press</code> messages:
</p>
<dl>
<dt><code class="keyword">#:val</code> <em>integer</em></dt>
<dd>An integer pressure change value 0-127. Defaults to 0.</dd>
</dl>

<p>
Keyword arguments applicable to <code class="entry">mm:bend</code> messages:
</p>
<dl>
<dt><code class="keyword">#:val</code> <em>integer</em></dt>
<dd>An integer pitch bend value 0-16383. Defaults to 0.</dd>
</dl>
</dd>
</dl>

<dl id="mm:free"><dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">mm:free</span> (<var> message</var>)<br/>&rarr; <var>void</var></code></dt>
<dd>
Deletes and reclaims memory from an allocated message. Note that the Midi Out port automatically frees messages once they are sent out the midi port. This function should be called by input hooks to free any message that it receives but does not use.
</dd>
</dl>

<dl id="mm:copy"><dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">mm:copy</span> (<var> message</var>)<br/>&rarr; <var>message</var></code></dt>
<dd>
Returns a copy of the specified midi message.
</dd>
</dl>

<dl id="mm:type?"><dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">mm:type?</span> (<var> message type</var>)<br/>&rarr; <var>bool</var></code></dt>
<dd>
Returns true if the MIDI <var>message</var> is of the specified <var>type</var>, one of <code class="entry">mm:off mm:on mm:touch mm:ctrl mm:prog mm:press mm:bend</code>.
</dd>
</dl>





<dl id="mm:time"><dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">mm:time</span> (<var> message</var>)<br/>&rarr; <var>float</var></code></dt>
<dd>
Returns the time value of a midi message.
</dd>
</dl>
<dl id="mm:time-set!"><dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">mm:time-set!</span> (<var> message value</var>)<br/>&rarr; <var>float</var></code></dt>
<dd>
Sets the time value of a midi message.
</dd>
</dl>

<dl id="mm:chan"><dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">mm:chan</span> (<var> message</var>)<br/>&rarr; <var>integer</var></code></dt>
<dd>
Returns the channel value of a midi message.
</dd>
</dl>
<dl id="mm:chan-set!"><dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">mm:chan-set!</span> (<var> message value</var>)<br/>&rarr; <var>integer</var></code></dt>
<dd>
Sets the channel value of a midi message.
</dd>
</dl>

<dl id="mm:key"><dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">mm:key</span> (<var> message</var>)<br/>&rarr; <var>integer</var></code></dt>
<dd>
Returns the key number of an <code class="entry">mm:on</code> or <code class="entry">mm:off</code> message.
</dd>
</dl>
<dl id="mm:key-set!"><dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">mm:key-set!</span> (<var> message value</var>)<br/>&rarr; <var>integer</var></code></dt>
<dd>
Sets the key number of an <code class="entry">mm:on</code> or <code class="entry">mm:off</code> message.
</dd>
</dl>

<dl id="mm:vel"><dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">mm:vel</span> (<var> message</var>)<br/>&rarr; <var>integer</var></code></dt>
<dd>
Returns the velocity value of an <code class="entry">mm:on</code> message.
</dd>
</dl>
<dl id="mm:vel-set!"><dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">mm:vel-set!</span> (<var> message value</var>)<br/>&rarr; <var>integer</var></code></dt>
<dd>
Sets the velocity value of an <code class="entry">mm:on</code> message.
</dd>
</dl>

<dl id="mm:val"><dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">mm:val</span> (<var> message</var>)<br/>&rarr; <var>integer</var></code></dt>
<dd>
Returns the message value of an <code class="entry">mm:touch mm:ctrl mm:prog mm:press mm:bend</code> message.
</dd>
</dl>
<dl id="mm:val-set!"><dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">mm:val-set!</span> (<var> message value</var>)<br/>&rarr; <var>integer</var></code></dt>
<dd>
Sets the message value of an <code class="entry">mm:touch mm:ctrl mm:prog mm:press mm:bend</code> message.
</dd>
</dl>

<dl id="mm:num"><dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">mm:num</span> (<var> message</var>)<br/>&rarr; <var>integer</var></code></dt>
<dd>
Returns the controller number of an <code class="entry">mm:ctrl</code> message.
</dd>
</dl>
<dl id="mm:num-set!"><dt style="background-color:#e6e6ff;"><code><span style="font-weight:bold;">mm:num-set!</span> (<var> message value</var>)<br/>&rarr; <var>integer</var></code></dt>
<dd>
Sets the controller number value of an <code class="entry">mm:ctrl</code> message.
</dd>
</dl>

<h2 id="sal">SAL Syntax</h2>
<p><a href="http://commonmusic.sf.net/doc/dict/sal-topic.html">SAL syntax</a> is fully supported in Chicken Scheme with the following enhancements over the Common Lisp implementation: </p>

<ul>

<li>The <code><span class="command">send</span></code> command sends data to ports:

<blockquote>
<pre><span class="command">send</span> <span class="string">"mp:note"</span>, 0, 1, 60, .1
<span class="command">send</span> <span class="string">"mp:note"</span>, <span class="keyword">key:</span> 60, <span class="keyword">dur:</span> .1
</pre>
</blockquote>
</li>

<li>Quasi-quotation is supported in constant lists. Use <code><span class="constant">#$</span></code> to unquote and <code><span class="constant">#^</span></code> to unquote-splice:

<blockquote>
<pre><span class="command">begin</span>
  <span class="reserved">with</span> foo = 99
  <span class="reserved">print</span> {x <span class="constant">#$</span> foo y <span class="constant">#^</span> list(foo, foo + 1, foo + 2) z}
<span class="command">end</span>
&rarr; {x 99 y 99 100 101 z}
</pre>
</blockquote>
</li>

<li>Variable length (&rest) parameters to functions or processes can
be defined by appending <code>...</code> to the last argument's
name.</li>

<blockquote>
<pre><span class="command">define</span> <span class="class">function</span> foo (a, b...)
  <span class="reserved">return</span> a * apply(+, b)
</pre>
</blockquote>


<li>Functions can be applied to arguments:
<blockquote>
<pre>
<span class="command">print</span> apply(+, {1 2 3 4 5})
</pre>
</blockquote>
</li>

<li>The commands <code><span class="command">open</span></code> and <code><span class="command">output</span></code> are not supported in Scheme.
</li>

</ul>

<p>See <a href="http://commonmusic.sf.net/doc/dict/sal-topic.html">SAL documentation</a> for more information.


<h2 id="examples">Code Examples</h2>

<h3 id="example1">Example 1</h3>


<p>Mapping pink noise onto scales.</p>

<div class="float">
<p><strong>Scheme</strong></p>
<pre class="code">
(<span class="special">define</span> (<span class="defined">pinkscale</span> len scale)
  (<span class="special">go</span> ((i 0 (+ i 1)))
      ((= i len) )
    (send <span class="string">"mp:note"</span> <span class="keyword">#:key</span> (discrete (ranpink) -1 1 scale))
    (wait .2)))

(<span class="special">define</span> <span class="defined">dorian</span> (steps 50 20 2 1 2 2 2 1 2))

(sprout (pinkscale 100 dorian))

(<span class="special">let</span> ((wierd (steps 40 20 2 (ran 1 4) 2 (ran 1 4) 2)))
  (sprout (pinkscale 100 wierd)))
</pre>
</div>

<div class="float">
<p><strong>SAL</strong></p>
<pre class="code">
<span class="command">define</span> <span class="class">process</span> pinkscale(len, scale)
  <span class="reserved">run</span> <span class="reserved">repeat</span> len
    <span class="reserved">send</span> <span class="string">"mp:note"</span>, <span class="keyword">key:</span> discrete( ranpink(), -1, 1, scale)
    <span class="reserved">wait</span> .2
  <span class="reserved">end</span>

<span class="command">define</span> <span class="class">variable</span> dorian = steps(50, 20, 2, 1, 2, 2, 2, 1, 2)

<span class="command">sprout</span> pinkscale(100, dorian)

<span class="command">begin</span> <span class="reserved">with</span> weird = steps(40, 20, ran(1,4), 2, ran(1,4), 2)
  <span class="reserved">print</span> <span class="string">"scale="</span>, weird
  <span class="reserved">sprout</span> pinkscale(100, weird)
<span class="command">end</span>
</pre>
</div>


<h3 id="example2">Example 2</h3>

<p>Using ids to selectively stop processes.</p>
<div class="float">
<p><strong>Scheme</strong></p>
<pre class="code">
(<span class="special">define</span> (<span class="defined">chopin</span> n r d k)
  (<span class="special">go</span> ((i 0 (+ i 1)))
      ((= i n) <span class="constant">#f</span>)
    (send <span class="string">"mp:note"</span> <span class="keyword">#:dur</span> d <span class="keyword">#:key</span> k)
    (wait r)))

<span class="comment">;; sprout D# minor chord with ids</span>

(<span class="special">begin</span> 
  (sprout (chopin 100 .5 .25 63) 0 1)
  (sprout (chopin 100 .5 .25 66) 0 2)
  (sprout (chopin 100 .5 .25 70) 0 3)
  (sprout (chopin 100 .5 .25 75) 0 1)
  )

<span class="comment">;; first stop F#, then A# then the D# octave</span>

(stop 2)
(stop 3)
(stop 1)
</pre>
</div>

<div class="float">
<p><strong>SAL</strong></p>
<pre class="code">
<span class="command">define</span> <span class="class">process</span> chopin (n, r, d, k)
  <span class="reserved">run</span> <span class="reserved">repeat</span> n
    <span class="reserved">send</span> <span class="string">"mp:note"</span>, <span class="keyword">dur:</span> d, <span class="keyword">key:</span> k
    <span class="reserved">wait</span> r
  <span class="reserved">end</span>

<span class="comment">;; sprout D# minor chord with ids</span>

<span class="command">begin</span>
  <span class="reserved">sprout</span> chopin(50, .5, .25, 63), 0, 1
  <span class="reserved">sprout</span> chopin(50, .5, .25, 66), 0, 2
  <span class="reserved">sprout</span> chopin(50, .5, .25, 70), 0, 3
  <span class="reserved">sprout</span> chopin(50, .5, .25, 75), 0, 1
<span class="command">end</span>

<span class="comment">;; first stop F#, then A# then the D# octave</span>

<span class="command">exec</span> stop(2)
<span class="command">exec</span> stop(3)
<span class="command">exec</span> stop(1)
</pre>
</div>


<h3 id="example3">Example 3</h3>

<p>Pentatonic wind chimes with amp envelope and exponential decay.</p>

<div class="float">
<p><strong>Scheme</strong></p>
<pre class="code">
(<span class="special">define</span> (<span class="defined">chimes</span> n)
  (<span class="special">go</span> ((i 0 (+ i 1))
       (l '(0 2 5 7 9 12))
       (k (+ 37 (* 12 (ran 6)))))
      ((= i n) <span class="constant">#f</span>)
    (send <span class="string">"mp:note"</span> 0 (ran 2.0 4.0)
          (+ k (list-ref l (ran 6)))
          (interp i 0 90 n 30))
    (wait (rescale i 0 n .1 (ran 1.5 2.0) 50))))

(sprout (chimes 20 ) )
</pre>
</div>

<div class="float">
<p><strong>SAL</strong></p>
<pre class="code">
<span class="command">define</span> <span class="class">process</span> chimes(n)
  <span class="reserved">run</span> <span class="reserved">with</span> l = {0 2 5 7 9 12}, k = 37 + (12 * ran(6))
    <span class="reserved">for</span> i <span class="reserved">below</span> n
    <span class="reserved">send</span> <span class="string">"mp:note"</span>, 0, ran( 2.0, 4.0),
         k + list-ref( l, ran( 6)),
         interp(i, 0, 90, n, 30)
    <span class="reserved">wait</span> rescale( i, 0, n, .1, ran(1.5, 2.0), 50)
  <span class="reserved">end</span>

<span class="command">sprout</span> chimes( 20 )
</pre>
</div>

 
<h3 id="example4">Example 4</h3>

<p>Triggering realtime processes via a MIDI input hook.</p>

<div class="float">
<p><strong>Scheme</strong></p>
<pre class="code">
<span class="comment">;; define a process thats plays a major or minor scale based on a given key</span>

(<span class="special">define</span> (<span class="defined">playscale</span> key dur)
  (<span class="special">let</span> ((scale (<span class="special">if</span> (odds .5)
                 (steps 15 key 2 2 1 2 2 2 1)
                 (steps 15 key 2 1 2 2 2 1 2))))
    (<span class="special">go</span> ((i 0 (+ i 1))
         (l (length scale))
         (r (/ dur (length scale))))
        ((= i l) <span class="constant">#f</span>)
      (send <span class="string">"mp:note"</span> <span class="keyword">#:key</span> (list-ref scale i) 
            <span class="keyword">#:dur</span> .5
            <span class="keyword">#:amp</span> (interp i 0 .9 l .5))
      (wait r))))

<span class="comment">;; test the process</span>
  
(sprout (playscale 60 1.2))

<span class="comment">;; define a hook to play a scale based on a key you press...</span>

(<span class="special">define</span> (<span class="defined">myhook</span> m)
  (<span class="special">if</span> (mm:type? m mm:on)
    (<span class="special">let</span> ((k (mm:key m)))
      (sprout (playscale k 1.2)))))

<span class="comment">;; set hook ...</span>

(send <span class="string">"mp:inhook"</span> myhook)

<span class="comment">;; now play your MIDI keyboard ...  then clear your hook when done</span>

(send <span class="string">"mp:inhook"</span> <span class="constant">#f</span>)
</pre>
</div>

<div class="float">
<p><strong>SAL</strong></p>
<pre class="code">
<span class="command">define</span> <span class="class">process</span> playscale(key, dur)
  <span class="reserved">run</span> <span class="reserved">with</span> scale = odds(.5, steps(15, key, 2, 2, 1, 2, 2, 2, 1),
                        steps(15, key, 2, 1, 2, 2, 2, 1, 2)), 
           len = length(scale)
    <span class="reserved">for</span> i <span class="reserved">below</span> len
    <span class="reserved">send</span> <span class="string">"mp:note"</span>, <span class="keyword">key:</span> list-ref( scale, i),
         <span class="keyword">dur:</span> .5,
         <span class="keyword">amp:</span> interp( i, 0, .9, len, .5)
    <span class="reserved">wait</span> dur / len
  <span class="reserved">end</span>

<span class="comment">;; test the process</span>
  
<span class="command">sprout</span> playscale( 60, 1.2)

<span class="comment">;; define a hook to play a scale based on a key you press...</span>

<span class="command">define</span> <span class="class">function</span> myhook (m)
  <span class="reserved">if</span> mm:type?( m, mm:on) <span class="reserved">then</span>
    <span class="reserved">begin</span> <span class="reserved">with</span> k = mm:key(m)
      <span class="reserved">sprout</span> playscale(k, 1.2)
    <span class="reserved">end</span>

<span class="comment">;; set hook ...</span>

<span class="command">send</span> "mp:inhook"</span>, myhook

<span class="comment">;; now play your MIDI keyboard ...  then clear your hook when done</span>

<span class="command">send</span> "mp:inhook"</span>, #f</span>
</pre>
</div>

<h3 id="example5">Example 5</h3>

<p>Sending audio data to the Csound port in realtime. (The i1 instrument is defined in the file 'grace.csd' located in the application's resource directory.)
</p>

<div class="float">
<p><strong>Scheme</strong></p>
<pre class="code">
<span class="comment"> </span>
(<span class="special">define</span> (<span class="defined">rani1</span> len rhy lb ub amp)
  (<span class="special">go</span> ((num 0 (+ num 1))
       (dur (* rhy 2))
       (key lb (ran lb ub)))
      ((= num len) <span class="constant">#f</span>)
    (send <span class="string">"cs:i"</span> 1 0 dur key amp)
    (wait rhy)
    ))

(sprout (rani1 10 .2 60 72 1000))
</pre>
</div>  

<div class="float">
<p><strong>SAL</strong></p>
<pre class="code">
<span class="command">define</span> <span class="class">process</span> ranins1(len, rhy, lb, ub, amp)
  <span class="reserved">run</span> <span class="reserved">with</span> dur = rhy * 2
    <span class="reserved">repeat</span> len
    <span class="reserved">for</span> key = lb <span class="reserved">then</span> ran(lb,ub)
    <span class="reserved">send</span> <span class="string">"cs:i"</span>, 1, 0, dur, key, amp
    <span class="reserved">wait</span> rhy
  <span class="reserved">end</span>

<span class="command">sprout</span> ranins1(10, .2, 60, 72, 1000)
</pre>
</div>  


<!-- 
<h2 id="xml">XML Description</h2>

<p>Plotter saves, loads, imports and exports data using
XML entities defined in the DTD file "grace/doc/grace.dtd". </p>

<p>Users can define their own Plotter points by declaring the
point using the XML <code>&lt;<span
class="xmlentity">pointdef</span>&gt;</code> ... <code>&lt;<span
class="xmlentity">/pointdef</span>&gt;</code> entity.  Here is the
definition of Plotter's (predefined) xy point: </p>

<pre>
&lt;<span class="xmlentity">pointdef</span>&gt;
  &lt;<span class="xmlentity">name</span>&gt;xy&lt;<span class="xmlentity">/name</span>&gt;
  &lt;<span class="xmlentity">fieldlist</span>&gt;
    &lt;<span class="xmlentity">field</span>&gt; &lt;<span class="xmlentity">name</span>&gt;x&lt;<span class="xmlentity">/name</span>&gt; &lt;<span class="xmlentity">type</span>&gt;float 0 1&lt;<span class="xmlentity">/type</span>&gt; &lt;<span class="xmlentity">default</span>&gt;0&lt;<span class="xmlentity">/default</span>&gt; &lt;<span class="xmlentity">/field</span>&gt;
    &lt;<span class="xmlentity">field</span>&gt; &lt;<span class="xmlentity">name</span>&gt;y&lt;<span class="xmlentity">/name</span>&gt; &lt;<span class="xmlentity">type</span>&gt;float 0 1&lt;<span class="xmlentity">/type</span>&gt; &lt;<span class="xmlentity">default</span>&gt;0&lt;<span class="xmlentity">/default</span>&gt; &lt;<span class="xmlentity">/field</span>&gt;
  &lt;<span class="xmlentity">/fieldlist</span>&gt;
&lt;<span class="xmlentity">/pointdef</span>&gt;
</pre>


<p>Point definitions can be converted to sound by providing a <code>
&lt;<span class="xmlentity">soundmap</span>&gt; ... &lt;<span
class="xmlentity">/soundmap</span>&gt; </code> entity that describes
how to transform the point's field values into data sent to a
port. For example, this description would convert an xy point into a
Midi Port note by converting point's <var>x</var> field to a time value
between 0 and 10, the <var>y</var> field to a key number between 60 72, and
constant values for duration (.5) amplitude (.25) and channel (0):</p>

<pre>
&lt;<span class="xmlentity">soundmap</span>&gt;
  &lt;<span class="xmlentity">mp:note </span>&gt;
    &lt;<span class="xmlentity">mp:time</span>&gt; &lt;<span class="xmlentity">source</span>&gt;x&lt;<span class="xmlentity">/source</span>&gt; &lt;<span class="xmlentity">scaler</span>&gt;10&lt;<span class="xmlentity">/scaler</span>&gt; &lt;<span class="xmlentity">/mp:time</span>&gt;
    &lt;<span class="xmlentity">mp:dur</span>&gt; &lt;<span class="xmlentity">source</span>&gt;.5&lt;<span class="xmlentity">/source</span>&gt; &lt;<span class="xmlentity">/mp:dur</span>&gt;
    &lt;<span class="xmlentity">mp:key</span>&gt; &lt;<span class="xmlentity">source</span>&gt;y&lt;<span class="xmlentity">/source</span>&gt; &lt;<span class="xmlentity">scaler</span>&gt;12&lt;<span class="xmlentity">/scaler</span>&gt; &lt;<span class="xmlentity">offset</span>&gt;60&lt;<span class="xmlentity">/offset</span>&gt; &lt;<span class="xmlentity">/mp:key</span>&gt;
    &lt;<span class="xmlentity">mp:amp</span>&gt; &lt;<span class="xmlentity">source</span>&gt;.25&lt;<span class="xmlentity">/source</span>&gt; &lt;<span class="xmlentity">scaler</span>&gt;127&lt;<span class="xmlentity">/scaler</span>&gt; &lt;<span class="xmlentity">/mp:amp</span>&gt;
    &lt;<span class="xmlentity">mp:chan</span>&gt; &lt;<span class="xmlentity">source</span>&gt;0&lt;<span class="xmlentity">/source</span>&gt; &lt;<span class="xmlentity">/mp:chan</span>&gt;
  &lt;<span class="xmlentity">/mp:note</span>&gt;
&lt;<span class="xmlentity">/soundmap</span>&gt;
</pre>


<p>User defined XML descriptions are saved in the
Grace.prefs file:
</p>

-->

</div>
</body>
</html>

