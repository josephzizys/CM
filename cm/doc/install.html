<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="content-type" content="text/html; charset=iso-8859-1"/>
<style type="text/css" media="all">
@import "css/cm.css";
</style>
<title>Installing Common Music</title>
</head>

<body>

<!-- Navbar -->
<div id="header">
<div id="logo">
<img src="img/cmlogosw.png" width="50" height="50" alt="[img/cmlogosw.png]" title=""/>
</div>
<div class="inv">Navagation:</div>
<ul class="nav">
<li class="nav1"><a href="cm.html">Home Page</a></li>
<li class="navn"><a href="dict/">Dictionary</a></li>
<li class="navn"><a href="../etc/examples/">Examples</a></li>
</ul>
</div>
<hr class="inv"/>

<div id="content">

<h1>Installing Common Music</h1>
<p>
This document describes how to install and build Common Music in
several common configurations. Building the system involves
downloading the sources, starting a <a
href="cm.html#implementations">supported Lisp implemetation</a>,
compiling CM's sources and saving an image file that contains the
application in it. This image file is then used with your Lisp program
to run the Common Music application inside a Terminal window or under
<a href="emacs.html">Emacs/Xemacs</a>. Once the Common Music appcliation is running you can
load and work with additional software systems like CLM, CNM and MidiShare.
</p>

<h2>Contents</h2>
<!--  style="list-style-type: upper-roman" -->
<ol>
<li><a href="#install_src">Downloading and restoring the sources<a/></li>
<li><a href="#start_lisp">Starting your lisp implementation</a></li>
<li><a href="#make_cm">Building Common Music from sources</a></li>
<li><a href="#run_cm">Running the Common Music application</a></li>
<li><a href="#install_sys">Working with CLM, CMN and MidiShare<a/></li>
</ol>


<h2 id="install_src">1. Downloading and restoring the sources</h2>

<p>
Common Music's sources can be installed from FTP archives or via
anonymous CVS. While the CVS tree contains the most up-to-date version
of the sources, these sources represent the "bleeding edge" of
development and may include bugs and untested features.
</p>

<h3 id="install_ftp">1.1 Downloaing and restoring using FTP</h3>

<ol>
<li>
Download the latest CM source archive from either:
<ul>
<li><a href="http://www.sf.net/projects/commonmusic">Sourceforge
Common Music Project</a></li>
<li><a
href="ftp://ftp-ccrma.stanford.edu/pub/Lisp/cm/sources/">ftp://ftp-ccrma.stanford.edu/pub/Lisp/cm/sources</a></li>
</ul>
</li>

<li>
Place the downloaded archive in an appropriate directory on your
machine.  If you are going to work with other Lisp packages such as
<a href="http://www-ccrma.stanford.edu/software/clm/">CLM</a>
or
<a href="http://www-ccrma.stanford.edu/software/cmn/">CMN</a> you
should consider creating a parent Lisp directory to organize all these
programs. For purposes of illustration, this document assumes that the
CM distribution archive is restored in a parent directory called Lisp
that is situated directly under the root directory of the file system:

<p>
<dl>
<dt>OS X and Linux:</dt>
<dd><code>/Lisp/</code></dd>
<dt>Windows:</dt>
<dd><code>C:\LISP\</code></dd>
<dt>MacOS:</dt>
<dd><code>Macintosh HD:Lisp:</code></dd>
</dl>
</li>
</p>

<li>
Restore the CM source archive with whatever softare you use on your
machine. This process should restore the contents of the archive under
a directory named cm-{version}, where {version} is the version number
of the CM release. For example, the archive file cm-2.4.0.tar.gz
should restore Common Music in a directory called cm-2.4.0. This
document will refer to this restored directory as the <em>CM
installation directory</em>.
<div class="float">
<p class="captxt">
Restoring the CM source archive on OS X and Linux.
</p>
<pre class="shell">% <span class="input">cd /Lisp</span>
% <span class="input">tar -zxvf cm-2.4.0.tar.gz</span>
<i>[...lots of printout deleted...]</i>
% <span class="input">ls -l cm-2.4.0</span>
drwxr-xr-x   5 hkt  admin   170 Nov 29 19:55 bin
drwxr-xr-x  11 hkt  admin   374 Nov 30 08:10 doc
drwxr-xr-x   7 hkt  admin   238 Nov 24 15:21 etc
-rw-r--r--   1 hkt  admin  1262 Nov 21 12:57 readme.text
drwxr-xr-x  58 hkt  admin  1972 Nov 29 20:41 src
% 
</pre>
</div>

<dl>
<dt class="platformnote">Windows and MacOS Note:</dt> 
<dd>
Since the archive is stored in gzipped unix tarfile format (.tar.gz),
make sure that your installer performs the necessary ASCII end-of-line
conversion when it unpacks the sources.  You can determine if it did
this correctly using <a
href="http://ccrma-www.stanford.edu/~craig/utility/flip/">flip -t</a>
or by editing the file <a
href="../readme.text">readme.text</a> in the top level CM
directory using Note Pad (Windows) or Simple Text (MacOS). If the file
is readable then presumably your installer performed the EOL
conversion correctly.
</dd>

<dt class="platformnote">Windows Note:</dt>
<dd>
Make sure that your installer really restores the archive's top-level
directory when it unpacks the distribution. Some installers on Windows
may choose to ignore the archive's top-level directory when the
archive is unpacked. These steps work for me using WinZip:
<ol>
<li>Place the archive in the parent directory that will hold the CM
distribution.</li>
<li>Right-button the archive file and choose <em>Install Here</em>
from the pop-up menu.</li>
</ol>
</dd>
</dl>
</ol>

<h3 id="install_cvs">1.2 Downloading and restoring using <a
href="http://www.loria.fr/~molli/cvs/doc/cvs_toc.html">CVS</h3>

<ol>
<li>
Change directories to the directory in which you want to install the
CM source tree.
</li>

<li>
Use anonymous CVS to login to the <a
href="http://sourceforge.net/cvs/?group_id=9766">Sourceforge CVS
repository</a>. Press the return key when prompted for a password.
</li>

<li>Use the CVS <a
href="http://www.loria.fr/~molli/cvs/doc/cvs_16.html#SEC115"><code>checkout</code></a>
command to restore the current CM source tree.
</li>
<li>Once the source tree has been restored to your machine you can
rename the top-level <kbd>cm</kbd> directory if you choose.
</li>
</ol>

<div class="float">
<p class="captxt">
Installing CM sources from the sourceforge CVS repository on OS X and Linux.
</p>
hkt@pinhead:/Lisp [14]% which clisp
/usr/local/bin/clisp
<pre class="shell">% <span class="input">cd /Lisp</span>
% <span class="input">cvs -d:pserver:anonymous@cvs.sourceforge.net:/cvsroot/commonmusic login</span>
CVS password: 
% <span class="input">cvs -z3 -d:pserver:anonymous@cvs.sourceforge.net:/cvsroot/commonmusic checkout cm</span>
<i>[...lots of printout deleted...]</i>
% <span class="input">mv cm cm-2.4.0</span>
</pre>
</div>

<h2 id="start_lisp">2. Starting your Lisp implementation</h2>

Before building Common Music you must first determine how to start up
your Lisp implementation. Some Lisp implementations install
a <em>shell command</em> that can be entered in a Terminal window (the
CMD window in Windows) to start Lisp running.  For example, when you
install Clisp on Linux or OS X a program called
<code>clisp</code> is automatically installed in an appropriate
program directory, for example /usr/bin or /usr/local/bin or /sw/bin.

<div class="float">
<p class="captxt">
Clisp's installed program on OS X and Linux.
</p>
<pre class="shell">% <span class="input">which clisp</span>
/usr/local/bin/clisp
%  <span class="input">clisp -q</span>
[1]&gt; <span class="input">(+ 1 2)</span>
3
[2]&gt; <span class="input">(quit)</span>
%
</pre>
</div>

On the other hand, installing Lisp from some binary distributions (For
example Clisp's binary Windows distribiution) will not automatically
install a shell command to start the Lisp program. In this case you
should read the installation readme to determine how to do this.  Even
if your Lisp implementation does NOT come with an installed command
you should create and install one yourself so that running Lisp inside
the Terminal or under Emacs/XEmacs is greatly simplified.
Unfortunately there is not a single way to do this that works for all
Lisp implementations and Operating Systems.  Here are three different
sets of instructions that will hopefully cover the most common cases
of installing Common Music, CLM and CMN:

<dl>
<dt class="platformnote">CLisp on Windows</dt> 
<dd>
Use a plain editor like Note Pad or Emacs to create a
Windows <em>batch file</em> called clisp.bat that contains the
contents shown below. Do not use a word processor like Word to do this
as it may store the file its own .doc format...)  Note that when you
type the text from the example into your batch file you will have to
change the actual pathname to Clisp's lisp.exe executable to the
correct pathname on your file system.  Once you have created the
clisp.bat file, save or move it to some directory on your
environment's command %path%, for example, the directory
C:\WINNT\WIN32\.

<div class="float">
<p class="captxt">
The contents of the Clisp batch file "clisp.bat" for Windows.
</p>
<pre class="shell">@echo off
REM
REM edit the path to lisp.exe to reflect your filesystem.
REM
C:\LISP\CLISP-2.31\FULL\LISP.EXE %1 %2 %3 %4 %5 %6 %7 %8 %9
</pre>
</div>
See foo for more information.
</dd>

<dt class="platformnote">OpenMCL on OS X</dt> 
<dd>
foo fuf.
</dd>

<dt class="platformnote">CMU on Linux</dt> 
<dd>
foo fuf.
</dd>

</dl>

<h2 id="make_cm">3. Building Common Music from sources</h2>
<p>
In the following discussion all Lisp software has been installed under
a main "/Lisp" directory. The examples show how the build process
appears in OpenMCL on OSX; if you use some other Lisp or operating
system the output will appear slightly differently as you perform each
step. 

Note that on Windows you should use the Unix directory character
"/" rather than the DOS directory character "\" when specifying
filenames to the
<kbd>load</kbd> function. If you are loading CM in Guile under Windows
from a directory that is not under Cygwin's file system you will have
to start the pathname with the drive,
i.e. "c:/Lisp/cm-2.4.0/src/cm.scm". If you are building CM on a
Macintosh using MCL Lisp (4.n or 5.n) then the directory delimiter
will be ":" instead of "/".
</p>

<ol>

<li>

<li>
If you are using Common Lisp and you do <em>not</em> want Scheme
symbols then perform the following action. Note that CM will add
Scheme's <kbd>define</kbd> macro even if <kbd>:no-scheme</kbd> is
defined as a feature.

<div class="float">
<p class="captxt">
Optionally configure Lisp for no Scheme symbols in Common Music.
</p>
<pre class="shell">? <span class="input">(push ':no-scheme *features*)</span></pre>
</div>
</li>

<li>
Load the CM build script, either "src/cm.scm" (Guile) or "src/cm.lisp"
(CL).  Specify the full, true pathname to the file, i.e. avoid
relative paths or using "~/" unless you are sure your Lisp supports
them:

<div class="float">
<p class="captxt">
Loading the CM build script in Guile (scheme):
</p>
<pre class="shell">% guile
guile&gt; <span class="input">(load "/Lisp/cm-2.4.0/src/cm.scm")</span>
<i>[...lots of printout deleted...]</i></pre>
</div>

<div class="float">
<p class="captxt">
Loading the CM build script in Common Lisp:
</p>
<pre class="shell">% openmcl
Welcome to OpenMCL Version (Beta: Darwin) 0.13.2!
? <span class="input">(load "/Lisp/cm-2.4.0/src/cm.lisp")</span>
<i>[...lots of printout deleted...]</i></pre>
</div>

<p>
In Guile the sources are simply loaded. In Common Lisp the sources are
complied and loaded.  Binary files, images and scripts are normally
saved in CM's "bin/" subdirectory. To save compiled files and images
somewhere else or to block an image file from being saved you can set
the appropriate build parameter before loading src/cm.lisp. The
names and default settings of these parameters are:
</p>

<p>
Directory strings in the build parameters must contain the directory
delimiter character at the end, i.e. "/Lisp/bin/" not "/Lisp/bin".
</p>
</li>

<li>
Instructions on how to save a Common Music image in Common Lisp will
be printed at the end of the compilation process.  In Guile no image
is saved.
</li>

<li>
If you are using Common Lisp, quit and restart lisp, then load the
"src/cm.lisp" script again. This pass will load the compiled files
into lisp and save the Common Music lisp image.

<div class="float">
<p class="captxt">
Quitting and reloading the build script in Common Lisp.
</p>
<pre class="shell">? <span class="input">(quit)</span>
% <span class="input">openmcl</span>
Welcome to OpenMCL Version (Beta: Darwin) 0.13.2!
? <span class="input">(load "/Lisp/cm-2.4.0/src/cm.scm")</span>
<i>[...lots of printout deleted...]</i></pre>
</div>
</li>

<li>
At the end of the load process CM will save several script files and a
default "cminit.lisp" file in the "bin/" directory.  The "bin/cm"
script can be used to start CM from a shell (terminal) window. The
script "bin/xcm" script will launch <a
href="http://www.xemacs.org">Xemacs</a> and start up CM in a dedicated
Lisp Listener window. Note that you must have the <kbd>xemacs</kbd>
program installed on your machine for this script to work. The xcm
script does not work with Gnu Emacs. See the directory "etc/xemacs/"
for more information about working with Common Music inside Xemacs.
</li>

<li>
Look at the file in "etc/examples/intro.cm" for an idea of how to work
with CM. Or better yet, buy the book "Notes from the Metalevel" :)
</li>
</ol>

<h3 id="build_scripts">Customized Build Scripts</h3> 

<p>
Once the script is defined save it as a lisp file and then load that
file rather than the generic "cm/src/cm.lisp":
</p>

<div class="float">
<p class="captxt">
Loading a custom build script called "loadall.lisp".
</p>

<pre class="shell">% <span class="input">openmcl</span>
Welcome to OpenMCL Version (Beta: Darwin) 0.13.2!
? <span class="input">(load "/Lisp/adm/loadall.lisp")</span>
<i>[...lots of printout deleted...]</i></pre>
</div>

<h2 id="run_cm">4. Running the Common Music application</h2>
<p>
foo fuf.
</p>

<h2 id="install_sys">5. Working with CLM, CMN and Midishare</h2>
<p>
To work with CLM or CLM simply load the system into Common Music using
the appropriate load command shown below.  If you would like to build
the CM application "prelinked" to one or both of these systems,
perform their load operations just prior to loading cm.lisp or using
the make-cm function. See <a href="#make_cm">Section 3</a> for
information on how to make the Common Music application.
</p>

<div class="float">
<p class="captxt">
Loading CLM into a running CM image.
</p>
<pre class="shell">
? <span class="input">(load "/Lisp/clm-2/all")</span>
<i>[...lots of printout deleted...]</i></pre>
</div>

<div class="float">
<p class="captxt">
Loading CMN into a running CM image.
</p>
<pre class="shell">? <span class="input">(load "/Lisp/cmn/cmn-all")</span>
<i>[...lots of printout deleted...]</i></pre>
</div>
</li>

<h3 id="install_ms">Installing Midishare</h3>
<p>
A direct connection from Common Music to one or more MIDI Drivers can
be established using <a
href="http://www.grame.fr/MidiShare/">Midishare</a>, a real-time MIDI
operating system developed by <a
href="http://www.grame.fr">Grame</a>. Common Music currently works
with Midishare in the following OS/Lisp combinations:
</p>

<ul>
<li>Linux/CMUCL</li>
<li>OSX/OpenMCL</li>
<li>OSX/MCL 5.0</li>
<li>MacOS 9.2/MCL 4.2, 4.3</li>
</ul>

<p>


Directions for Installing Midishare.
</p>

<ol>

<li>
Download, install and configure the Midishare and Developer packages
from the <a href="ftp://ftp.grame.fr/pub/MidiShare/">Midishare FTP
Server</a>.  Be sure to set up your MidiShare driver ports (msDriver)
and test your MIDI connection (msController) before attempting to
build CM with Midishare.
</li>

<li>
If you are running OpenMCL, download <a
href="ftp://ftp-ccrma.stanford.edu/pub/Lisp/cm/openmcl-midishare.tar.gz">openmcl-midishare.tar.gz</a>
from the CCRMA ftp server and untar the archive in
"ccl/darwin-headers/", i.e. the "darwin-headers/" subdirectory of your
OpenMCL distribution:

<div class="float">
<p class="captxt">
Installing the Midishare FFI in OSX/OpenMCL
</p>
<pre class="shell">% <span class="input">cd /Lisp/ccl/darwin-headers</span>
% <span class="input">tar -zxf openmcl-midishare.tar.gz</span></pre>
</div>
</li>

<li>
If you are running MacOS 9.n, move the shared library "PlayerSharedPPC" from the
developer package into your System Extensions folder.
</li>

<li>
Set the <code>use-midishare</code> build parameter to true and
build the Common Music image as discussed in the <a
href="#build_src">previous section</a> of this document.
</li>

<li>
If you are using OpenMCL or MCL, edit your "bin/cminit.lisp" file and
add the following forms. Be sure to change the absolute pathname
directory strings to match your filesystem first.

<div class="float">
<p class="captxt">
Adding CCL logical host translations to cminit.lisp
</p>
<pre class="code">#+(and <span class="keyword">:mcl :digitool</span>)
(setf (logical-pathname-translations <span class="string">"ccl"</span>)
      `((<span class="string">"**;*.*"   "Macintosh HD:Lisp:MCL 4.2:**:*.*"</span>)))
#+<span class="keyword">:openmcl</span>
(setf (logical-pathname-translations <span class="string">"ccl"</span>)
      `((<span class="string">"**;*.*"   "/Lisp/ccl/**/*.*"</span>)))
</pre>
</div>
</li>
</ol>

</div>

<!-- end content -->

<div id="footer">
<div id="author">H. Taube</div>
<div id="cvs-info">$Name$: $Source$ ($Revision$, $Date$)</div>
</div>

</body>
</html>
