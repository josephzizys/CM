<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="content-type" content="text/html; charset=iso-8859-1"/>
<style type="text/css" media="all">
@import "../css/cm.css";
</style>
<title>Portmidi</title>
</head>

<body>
<div id="content"> <!-- begin content -->
<dl class="dictsyntax">
<dt>[Topic]</dt>

<dd>Portmidi</dd>
</dl>

<p>
Common Music supports reading and writing MIDI messages to and from
 <a href="http://www-2.cs.cmu.edu/~music/portmusic/">Portmidi</a>, an
open-source, cross-platform MIDI device library. CM supports Portmidi
on OS X and Linux in OpenMCL, SBCL and CMUCL. The support consists of
a <a href="#portmidi-stream"><code>portmidi-stream</code></a> class to
manage different Portmidi input/output devices and a handful of
auxiliary functions for querying Portmidi about its current
configuration and for accessing its millisecond timer. To work with
Portmidi you must compile the Portmidi and Porttime libraries as
shared libs (libport*.dylib on OS X and libport*.so on Linux) and install in
/usr/local/lib.

Note also that on Linux you may have to load the snd-seq-* kernel
modules before starting CM with Portmidi. These modules are not loaded
by default, perhaps something like this will work:
<blockquote>
<pre><span style="font-weight:bold;">$</span> modprobe snd_seq_midi snd_seq_oss snd_seq_midi_emul</pre>
</blockquote>
</p>

<h4>The Portmidi stream</h4>

<dl class="dictsyntax" id="portmidi-stream">
<dt>[Class]</dt>
<dd><code class="entry">portmidi-stream</code></dd>
</dl>

<p>
Manages resources and connections between CM and Portmidi input and
output devices. This class is automatically chosen when you specify a
stream with a .pm extension. The convenience
functions <a href="#portmidi-open"><code>portmidi-open</code></a>
and <a href="#portmidi-close"><code>portmidi-close</code></a> are
provided for the typical case of a single input/output pair.  Opening
a portmidi-stream initializes the library and starts the millisecond
timer if they have not been initialized.
</p>

<p id="args"><code class="entry">portmidi-stream</code> supports the
following slot initializations:
</p>
<dl>

<dt>
<code class="keyword">:input</code> {<var>string</var>  | <var>integer</var> | <var>boolean</var>}
</dt>
<dd>
<!-- Omit if only an <code class="keyword">:output</code> device is
required. --> If the value is true then Portmidi's default input
device is opened, as determined
by <a href="#GetDefaultInputDeviceID">pm:GetDefaultInputDeviceID</a> .
If the value is false then no input device is opened. Otherwise the
value should be the name or identifier of a Portmidi input device to
open. The
function <a href="#GetDeviceDescriptions">pm:GetDeviceDescriptions</a>
can be used to determine the names and ids of available Portmidi
devices. The default value is true.
</dd>

<dt>
<code class="keyword">:output</code> {<var>string</var> | <var>integer</var> | <var>boolean</var>}
</dt>
<dd>The optional name or identifier of a Portmidi output device to
open. Omit if only an <code class="keyword">:input</code> device is
required.  The
function <a href="#GetDeviceDescriptions">pm:GetDeviceDescriptions</a>
can be used to determine the names and ids of available Portmidi
devices.</dd>

<dt>
<code class="keyword">:latency</code> <var>integer</var>
</dt>
<dd>A millisecond value that determines how Portmidi treats MIDI
message timestamps in data sent to it from CM. If the value is zero
then Portmidi operates in "realtime" mode and MIDI messages are sent
to the destination device as soon as Portmidi receives them,
regardless of message timestamps. If the latency value is greater than
zero then Portmidi delays future messages until
<var>timestamp</var>+<var>latency</var>. The default value is 100ms.
</dd>

<dt>
<code class="keyword">:inbuf-size</code> <var>integer</var>
</dt>
<dd>The size of the event buffer that will be allocated to hold
incoming midi data when the input device is read. The default value is
64.
</dd>

<dt>
<code class="keyword">:outbuf-size</code> <var>integer</var>
</dt>
<dd>The size of the event buffer Portmidi allocates to queue future
messages. The default value is 256.
</dd>

<dt>
<code class="keyword">:filter</code> {<var>keyword</var> | <var>list</var>}
</dt>
<dd>An optional filter keyword or list of filter keywords. Filtering
means that the specified types of messages will be ignored by the open
Portmidi devices. The value can be one or more keywords from the
following set of choices:

<blockquote>
<p><code class="keyword">:pm-filt-active :pm-filt-sysex :pm-filt-clock :pm-filt-play :pm-filt-f9 :pm-filt-fd :pm-filt-reset :pm-filt-note :pm-filt-channel-aftertouch :pm-filt-poly-aftertouch :pm-filt-program :pm-filt-control :pm-filt-pitchbend :pm-filt-mtc :pm-filt-song-position :pm-filt-song-select :pm-filt-tune
:pm-filt-tick :pm-filt-undefined :pm-filt-realtime :pm-filt-aftertouch :pm-filt-systemcommon</code>.
</p>
</blockquote>
</dd>

<dt>
<code class="keyword">:mask</code> <var>integer</var>
</dt>
<dd>An optional bit mask where each 1-bit enables a channel in the
open device. For example the mask value #b1101 will enable messages
only on channels 1, 3 and 4. By default all channels are enabled.
</dd>
</dl>

<h4>Auxiliary Functions</h4>

CM provides some utility functions to facilitate working with
Portmidi. Most of these functions are exported from the Portmidi
package and can be referenced using the pm: package prefix.

<dl class="dictsyntax" id="portmidi-open">
<dt>[Function]</dt>
<dd><code>(</code><code class="entry">portmidi-open</code> . <var>args</var> <code>)</code></dd>
</dl>
<p>
Opens a <a href="#portmidi-stream">portmidi-stream</a>
called <span class="string">"midi-port.pm"</span> according to the
keyword initialization <var>args</var> passed to the stream. The
function <a href="#GetDeviceDescriptions">pm:GetDeviceDescriptions</a>
can be used to determine the names and ids of available Portmidi
devices.
</p>

<dl class="dictsyntax" id="portmidi-open?">
<dt>[Function]</dt>
<dd><code>(</code><code class="entry">portmidi-open?</code><code>)</code></dd>
</dl>
<p>
Tests to see if <span class="string">"midi-port.pm"</span> has already been opened, returns one of four possible values:  <code class="keyword">:input</code>, <code class="keyword">:output</code>, <code class="keyword">:inout</code> or false.
</p>

<dl class="dictsyntax" id="portmidi-close">
<dt>[Function]</dt>
<dd><code>(</code><code class="entry">portmidi-close</code><code>)</code></dd>
</dl>
<p>
Closes the <a href="portmidi-stream">portmidi-stream</a> called <span class="string">"midi-port.pm"</span> if it is open, otherwise has no effect.
</p>


<dl class="dictsyntax" id="pm:CountDevices">
<dt>[Function]</dt>
<dd><code>(</code><code class="entry">pm:CountDevices</code><code>)</code></dd>
</dl>
<p>Returns the number of available Portmidi devices.</p>


<dl class="dictsyntax" id="GetDeviceDescriptions">
<dt>[Function]</dt>
<dd><code>(</code><code class="entry">pm:GetDeviceDescriptions</code><code>)</code></dd>
</dl>
<p>
Returns a list of the device id (integer), name (string) device type
(keyword) and open status (boolean) of each available Portmidi
device. <!-- To open a device pass its name or id as
the <code class="keyword">:input</code> or
<code class="keyword">:output</code> initialization to
a <a href="#portmidi-stream">portmidi-stream</a>. --> Note that
devices added after the library has been loaded will not be reflected
in the list of descriptions. Calling this function initializes the
Portmidi library if it has not already been initialized.
</p>


<dl class="dictsyntax" id="Time">
<dt>[Function]</dt>
<dd><code>(</code><code class="entry">pm:Time</code><code>)</code></dd>
</dl>
<p>
Returns the current millisecond time from Porttime. This function
should not be called unless a Portmidi stream has already been opened
or you have called the <code>pm:TimeStart</code> function to
initialize Porttime first.
</p>

<h4>Examples:</h4>
<div class="float">
<p class="captxt">
<span class="floatlabel">Example 1.</span> Accessing Portmidi information and opening a Portmidi stream.
</p>
<pre class="code">
(pm:CountDevices)
<span class="result">&rArr;</span> 4
(pm:GetDeviceDescriptions)
<span class="result">&rArr;</span> ((<span class="keyword">:id</span> 0 <span class="keyword">:name</span> <span class="string">"IAC Driver: IAC Bus 1"</span> <span class="keyword">:type</span> <span class="keyword">:input</span> <span class="keyword">:open</span> #f)
    (<span class="keyword">:id</span> 1 <span class="keyword">:name</span> <span class="string">"1x1: Port 1"</span> <span class="keyword">:type</span> <span class="keyword">:input</span> <span class="keyword">:open</span> #f)
    (<span class="keyword">:id</span> 2 <span class="keyword">:name</span> <span class="string">"IAC Driver: IAC Bus 1"</span> <span class="keyword">:type</span> <span class="keyword">:output</span> <span class="keyword">:open</span> #f)
    (<span class="keyword">:id</span> 3 <span class="keyword">:name</span> <span class="string">"1x1: Port 1"</span> <span class="keyword">:type</span> <span class="keyword">:output</span> <span class="keyword">:open</span> #f))
(pm:GetDefaultInputDeviceID)
<span class="result">&rArr;</span> 0
(pm:GetDefaultOutputDeviceID)
<span class="result">&rArr;</span> 2
(portmidi-open :output 3 :input #f)
<span class="result">&rArr;</span> #&lt;portmidi-stream <span class="string">"midi-port.pm"</span> (out:3)&gt;
(portmidi-open?)
<span class="result">&rArr;</span> <span class="keyword">:out</span>
(pm:Time)
<span class="result">&rArr;</span> 36993
</pre>
</div> 

<h4>See also:</h4>
<ul>
<li><a href="midi-topic.html">MIDI</a> [Topic]</li>
<li><a href="receive-fn.html"><code>receive</code></a> [Function]</li>
</ul>

</div> <!-- end content -->
<hr class="inv"/>
<!-- Footer -->
<div id="footer">
<div id="version">$Name$</div>
<div id="cvs-info">($Revision$, $Date$)</div>
</div>
</body>
</html>
